<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Request</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {font-family: Arial, sans-serif; margin:10px; background:#f5f7fb;}
#calendar {max-width:900px; margin:10px auto 0 auto;}
.calendar-hint{
  text-align:center;
  font-size:16px;
  color:#1e88e5;
  margin-bottom:10px;
  min-height:22px;
}

.overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); display:none;
  justify-content:center; align-items:center;
  z-index:1000;
}

.popup {
  background:white; width:95%; max-width:500px;
  max-height:90vh; overflow-y:auto;
  border-radius:12px; padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.3);
  position:relative;
}

.closeBtn {position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer;}
h2 {text-align:center; font-size:18px; margin-bottom:10px;}

input, select {
  width:100%; padding:10px; margin-top:5px; margin-bottom:12px;
  border-radius:8px; border:1px solid #ccc;
}

label {font-weight:bold;}
.row {display:flex; align-items:center; gap:10px;}

.circle-btn {
  width:35px; height:35px; border-radius:50%;
  border:none; background:#1e88e5; color:white;
  font-size:18px; cursor:pointer;
}

.counter {font-size:18px; font-weight:bold; min-width:30px; text-align:center;}

button.submitBtn {
  background:#1e88e5; color:white; border:none;
  padding:14px; width:100%; font-size:16px;
  border-radius:10px; cursor:pointer;
  opacity:0.5;
}

button.submitBtn.enabled {opacity:1;}
.summary {background:#e3f2fd; padding:12px; border-radius:10px; margin-bottom:15px;}

#adminBtn{
  position:fixed;
  top:10px;
  left:10px;
  z-index:2000;
  background:#1e88e5;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>

<button id="adminBtn">Admin</button>

<div class="overlay" id="adminLoginOverlay">
  <div class="popup">
    <div class="closeBtn" onclick="closeAdminLogin()">✖</div>
    <h2>Area Admin</h2>

    <label>Email</label>
    <input type="email" id="adminEmail">

    <label>Password</label>
    <input type="password" id="adminPassword">

    <button class="submitBtn enabled" onclick="adminLogin()">Accedi</button>
  </div>
</div>

<div id="calendarHint" class="calendar-hint">
Seleziona data di check-in | Select check-in date
</div>
<div id="calendar"></div>

<div class="overlay" id="overlay">
  <div class="popup">
    <div class="closeBtn" onclick="closeForm()">✖</div>

    <h2>Dettagli richiesta di prenotazione | Booking Request Details</h2>
    <div class="summary" id="summaryBox"></div>

    <label>Camere | Rooms (max 3) *</label>
    <div class="row">
      <button class="circle-btn" type="button" onclick="changeRooms(-1)">−</button>
      <div class="counter" id="rooms">1</div>
      <button class="circle-btn" type="button" onclick="changeRooms(1)">+</button>
    </div>

    <label>Ospiti | Guests (max 2 per camera) *</label>
    <div class="row">
      <button class="circle-btn" type="button" onclick="changeGuests(-1)">−</button>
      <div class="counter" id="guests">2</div>
      <button class="circle-btn" type="button" onclick="changeGuests(1)">+</button>
    </div>

    <label>Nome | First Name *</label>
    <input type="text" id="firstName" required>

    <label>Cognome | Last Name *</label>
    <input type="text" id="lastName" required>

    <label>Telefono | Phone *</label>
    <div class="row">
      <select id="prefix" required></select>
      <input type="tel" id="phone" required>
    </div>

    <label>Email | Email *</label>
    <input type="email" id="email" required>

    <label>Conferma Email | Confirm Email *</label>
    <input type="email" id="confirmEmail" required>

    <label>Paese | Country *</label>
    <select id="country" required></select>

    <button id="submitBtn" class="submitBtn" onclick="sendBooking()" disabled>Invia Richiesta</button>
  </div>
</div>

<div class="overlay" id="adminCalendarOverlay">
  <div class="popup" style="max-width:900px;">
    <div class="closeBtn" onclick="closeAdminCalendar()">✖</div>
    <h2>Calendario Admin (Modifica Prezzo e Camere)</h2>
    <div id="adminCalendar"></div>

    <div id="adminEdit" style="margin-top:15px;">
      <label>Prezzo per notte (€)</label>
      <input type="number" id="adminPrice" min="1">
      <label>Camere disponibili</label>
      <input type="number" id="adminRooms" min="1" max="3">
      <button class="submitBtn enabled" onclick="saveAdminChanges()">Salva modifiche</button>
    </div>
  </div>
</div>

<script>
emailjs.init("lTdk4iSo1q1QytRhq");

const today = new Date(); today.setHours(0,0,0,0);
const maxDate = new Date(); maxDate.setMonth(maxDate.getMonth()+7);

let checkin=null, checkout=null;
let bookingData = JSON.parse(localStorage.getItem("bookingData")||"{}");

// ========== Booking Calendar ==========
const hint = document.getElementById("calendarHint");
const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView:'dayGridMonth',
  locale:'it',
  selectable:true,
  validRange:{ start: today, end: maxDate },
  dateClick(info){
    const dateStr = info.dateStr;
    const dayData = bookingData[dateStr]||{blocked:false};

    if(dayData.blocked) return;

    let clicked = new Date(dateStr);
    if(!checkin || checkout){
      checkin = clicked; checkout = null; clearSel(); mark(clicked);
      hint.innerText="Seleziona data di check-out | Select check-out date";
    } else {
      if(clicked<=checkin){checkin=clicked; clearSel(); mark(clicked); return;}
      // Verifica blocchi intermedi
      let temp = new Date(checkin);
      let validCheckout = clicked;
      while(temp<=clicked){
        const ds = temp.toISOString().split('T')[0];
        if(bookingData[ds] && bookingData[ds].blocked){
          validCheckout = new Date(temp);
          validCheckout.setDate(validCheckout.getDate()-1);
          break;
        }
        temp.setDate(temp.getDate()+1);
      }
      checkout = validCheckout;
      markRange(checkin, checkout);
      showForm();
      hint.innerText="";
    }
  },
  dayCellDidMount(info){
    const dateStr = info.date.toISOString().split('T')[0];
    if(bookingData[dateStr] && bookingData[dateStr].blocked){
      info.el.style.background="#ff8a80";
      info.el.style.pointerEvents="none";
      info.el.style.opacity=0.6;
    }
  }
});
calendar.render();

function mark(d){document.querySelector(`[data-date='${d.toISOString().split('T')[0]}']`).style.background="#a5d6ff";}
function markRange(s,e){let c=new Date(s); while(c<=e){mark(c); c.setDate(c.getDate()+1);}}
function clearSel(){document.querySelectorAll("[data-date]").forEach(el=>el.style.background="");}

function showForm(){
  document.getElementById("overlay").style.display="flex";
  updateSummary();
  validateForm();
}

function closeForm(){document.getElementById("overlay").style.display="none"; clearSel(); checkin=null; checkout=null; hint.innerText="Seleziona data di check-in | Select check-in date";}

function updateSummary(){
  let nights=(checkout-checkin)/(1000*60*60*24);
  let r=parseInt(rooms.innerText);
  let total=0;
  let curr=new Date(checkin);
  for(let i=0;i<nights;i++){
    const ds = curr.toISOString().split('T')[0];
    let price = bookingData[ds] ? bookingData[ds].price : 100;
    total+=price*r;
    curr.setDate(curr.getDate()+1);
  }
  summaryBox.innerHTML=`<b>Check-in:</b> ${checkin.toLocaleDateString()}<br>
                        <b>Check-out:</b> ${checkout.toLocaleDateString()}<br>
                        <b>Notti:</b> ${nights}<br>
                        <b>Totale soggiorno:</b> €${total}`;
}

function changeRooms(v){let r=parseInt(rooms.innerText)+v; if(r<1)r=1;if(r>3)r=3;rooms.innerText=r; changeGuests(0); updateSummary();}
function changeGuests(v){let max=parseInt(rooms.innerText)*2; let g=parseInt(guests.innerText)+v; if(g<1)g=1;if(g>max)g=max; guests.innerText=g; updateSummary();}

function validateForm(){
  const requiredFields=["firstName","lastName","phone","email","confirmEmail"];
  let valid=true;
  requiredFields.forEach(id=>{if(!document.getElementById(id).value.trim()) valid=false;});
  if(prefix.value==="" || country.value==="") valid=false;
  if(email.value!==confirmEmail.value) valid=false;

  submitBtn.disabled=!valid;
  submitBtn.classList.toggle("enabled", valid);
}

document.querySelectorAll("input,select").forEach(el=>el.addEventListener("input",validateForm));

function sendBooking(){
  if(submitBtn.disabled) return;

  let nights=(checkout-checkin)/(1000*60*60*24);
  let r=parseInt(rooms.innerText);
  let totalPrice=0;
  let curr=new Date(checkin);
  for(let i=0;i<nights;i++){
    const ds=curr.toISOString().split('T')[0];
    let price = bookingData[ds] ? bookingData[ds].price : 100;
    totalPrice+=price*r;
    curr.setDate(curr.getDate()+1);
  }

  let params = {
    name: firstName.value + " " + lastName.value,
    checkin: checkin.toLocaleDateString(),
    checkout: checkout.toLocaleDateString(),
    guests: guests.innerText,
    rooms: rooms.innerText,
    phone: prefix.value+" "+phone.value,
    email: email.value,
    country: country.value,
    totalPrice: totalPrice
  };

  emailjs.send("service_IlFicobnb","template_pr1fttu", params)
  .then(()=>{alert("Richiesta inviata!"); location.reload();},
        ()=>alert("Errore invio"));
}

/* ================= ADMIN AREA ================= */
const ADMIN_EMAIL="ilficolakeiseo@gmail.com";
const ADMIN_PASS="cyb579wf&/TG47H@@&%TTgs";

document.getElementById("adminBtn").addEventListener("click",()=>document.getElementById("adminLoginOverlay").style.display="flex");
function closeAdminLogin(){document.getElementById("adminLoginOverlay").style.display="none";}
function adminLogin(){
  if(adminEmail.value===ADMIN_EMAIL && adminPassword.value===ADMIN_PASS){
    closeAdminLogin(); openAdminCalendar();
  }else alert("Credenziali errate");
}

let adminCalendar;
let selectedAdminDates=[];

function openAdminCalendar(){
  document.getElementById("adminCalendarOverlay").style.display="flex";
  if(adminCalendar) return;

  adminCalendar = new FullCalendar.Calendar(document.getElementById('adminCalendar'), {
    initialView:'dayGridMonth',
    locale:'it',
    selectable:true,
    dateClick(info){
      const dateStr = info.dateStr;
      const idx = selectedAdminDates.indexOf(dateStr);
      if(idx>=0) selectedAdminDates.splice(idx,1);
      else selectedAdminDates.push(dateStr);
      renderAdminSelection();
      if(selectedAdminDates.length===1){
        const data = bookingData[dateStr]||{price:100, rooms:3, blocked:false};
        adminPrice.value=data.price;
        adminRooms.value=data.rooms;
      }
    }
  });

  adminCalendar.render();
  renderAdminEvents();
}

function renderAdminEvents(){
  adminCalendar.removeAllEvents();
  for(let d in bookingData){
    if(bookingData[d].blocked){
      adminCalendar.addEvent({start:d, allDay:true, display:'background', backgroundColor:'#ff5252'});
    }
  }
  renderAdminSelection();
}

function renderAdminSelection(){
  adminCalendar.getEvents().forEach(ev=>{
    if(selectedAdminDates.includes(ev.startStr)){
      ev.setProp('backgroundColor','#42a5f5');
    }else if(bookingData[ev.startStr] && bookingData[ev.startStr].blocked){
      ev.setProp('backgroundColor','#ff5252');
    }
  });
}

function saveAdminChanges(){
  const price = parseFloat(adminPrice.value);
  const roomsVal = parseInt(adminRooms.value);

  selectedAdminDates.forEach(d=>{
    bookingData[d] = bookingData[d] || {price:100, rooms:3, blocked:false};
    if(!isNaN(price)) bookingData[d].price = price;
    if(!isNaN(roomsVal)) bookingData[d].rooms = roomsVal;
  });

  localStorage.setItem("bookingData", JSON.stringify(bookingData));
  renderAdminEvents();
  calendar.render();
}

function closeAdminCalendar(){
  document.getElementById("adminCalendarOverlay").style.display="none";
  selectedAdminDates=[];
}

/* PREFIX + COUNTRY */
const prefixList = ["+39 Italia","+44 UK","+1 USA","+33 Francia","+49 Germania","+34 Spagna","+41 Svizzera","+43 Austria","+32 Belgio","+31 Paesi Bassi","+351 Portogallo","+353 Irlanda","+45 Danimarca","+46 Svezia","+47 Norvegia","+48 Polonia","+420 Repubblica Ceca","+421 Slovacchia","+36 Ungheria","+30 Grecia","+90 Turchia","+7 Russia","+380 Ucraina","+40 Romania","+359 Bulgaria","+385 Croazia","+386 Slovenia","+381 Serbia","+387 Bosnia","+382 Montenegro","+355 Albania","+373 Moldavia","+370 Lituania","+371 Lettonia","+372 Estonia","+354 Islanda","+375 Bielorussia","+995 Georgia","+374 Armenia","+994 Azerbaigian","+20 Egitto","+212 Marocco","+213 Algeria","+216 Tunisia","+27 Sudafrica","+234 Nigeria","+254 Kenya","+971 Emirati","+966 Arabia Saudita","+972 Israele","+91 India","+92 Pakistan","+880 Bangladesh","+94 Sri Lanka","+977 Nepal","+86 Cina","+81 Giappone","+82 Corea","+84 Vietnam","+66 Thailandia","+60 Malesia","+65 Singapore","+62 Indonesia","+63 Filippine","+61 Australia","+64 Nuova Zelanda","+55 Brasile","+54 Argentina","+56 Cile","+57 Colombia","+52 Messico","+51 Perù","+58 Venezuela","+1 Canada","+598 Uruguay","+595 Paraguay","+593 Ecuador","+591 Bolivia","+502 Guatemala","+503 El Salvador","+504 Honduras","+505 Nicaragua","+506 Costa Rica","+507 Panama","+53 Cuba","+1 Rep Dominicana","+1876 Giamaica","+974 Qatar","+965 Kuwait","+968 Oman","+973 Bahrain","+961 Libano","+962 Giordania","+98 Iran","+93 Afghanistan","+856 Laos","+855 Cambogia","+95 Myanmar","+976 Mongolia","+998 Uzbekistan","+993 Turkmenistan","+996 Kirghizistan","+992 Tagikistan"];
const countryList = prefixList.map(p=>p.split(" ").slice(1).join(" "));
prefixList.forEach(p=>prefix.add(new Option(p,p)));
countryList.forEach(c=>country.add(new Option(c,c)));
</script>
</body>
</html>
