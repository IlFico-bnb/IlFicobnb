<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prenota | Book Now</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {font-family: Arial, sans-serif; margin:20px; background:#f5f7fb;}
h2 {text-align:center;}
#calendar {max-width:900px; margin:20px auto;}
.fc-daygrid-day-number {font-weight:bold;}
.price-tag {font-size:12px; color:#1e88e5;}
.selected-range {background:#a5d6ff !important;}
.today-past {background:#ffe0b2 !important;}
#bookingForm {max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
input, select {width:100%; padding:8px; margin-top:5px; margin-bottom:10px;}
label {font-weight:bold;}
.row {display:flex; gap:10px;}
button {background:#1e88e5; color:white; border:none; padding:12px; width:100%; font-size:16px; border-radius:8px; cursor:pointer;}
button:hover {background:#1565c0;}
.summary {background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px;}
.highlight-date {font-weight:bold; color:#0d47a1;}
</style>
</head>

<body>

<h2>Dettagli Prenotazione | Booking Details</h2>
<div id="calendar"></div>

<div id="bookingForm" style="display:none;">
  <div class="summary" id="summaryBox"></div>

  <label>Camere | Rooms (max 3)</label>
  <div class="row">
    <button type="button" onclick="changeRooms(-1)">-</button>
    <input type="text" id="rooms" value="1" readonly>
    <button type="button" onclick="changeRooms(1)">+</button>
  </div>

  <label>Ospiti | Guests (max 2 per camera)</label>
  <div class="row">
    <button type="button" onclick="changeGuests(-1)">-</button>
    <input type="text" id="guests" value="2" readonly>
    <button type="button" onclick="changeGuests(1)">+</button>
  </div>

  <div id="guestNames"></div>

  <label>Telefono | Phone *</label>
  <div class="row">
    <select id="prefix">
      <option value="+39 Italia">+39 Italia</option>
      <option value="+44 UK">+44 UK</option>
      <option value="+1 USA">+1 USA</option>
      <option value="+33 Francia">+33 Francia</option>
      <option value="+49 Germania">+49 Germania</option>
    </select>
    <input type="tel" id="phone" required>
  </div>

  <label>Email *</label>
  <input type="email" id="email" required>

  <label>Conferma Email | Confirm Email *</label>
  <input type="email" id="confirmEmail" required>

  <label>Paese | Country *</label>
  <select id="country" required>
    <option>Italia</option><option>Germany</option><option>France</option><option>USA</option><option>UK</option>
  </select>

  <button onclick="sendBooking()">Invia Richiesta</button>
</div>

<script>
emailjs.init("lTdk4iSo1q1QytRhq");

let checkin=null, checkout=null, priceData={}, defaultPrice=100;

const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
  initialView: 'dayGridMonth',
  selectable:true,
  locale:'it',
  dateClick(info){
    let clicked = new Date(info.dateStr);
    let today = new Date(); today.setHours(0,0,0,0);
    if(clicked < today) return;

    if(!checkin || (checkin && checkout)){
      checkin = clicked;
      checkout = null;
      clearSelection();
      highlightDate(clicked);
    } else {
      if(clicked <= checkin){ checkin = clicked; clearSelection(); highlightDate(clicked); return;}
      checkout = clicked;
      highlightRange(checkin, checkout);
      showForm();
    }
  },
  dayCellDidMount(info){
    let today = new Date(); today.setHours(0,0,0,0);
    if(info.date < today) info.el.classList.add("today-past");

    let price = priceData[info.dateStr] || defaultPrice;
    let tag = document.createElement("div");
    tag.className="price-tag";
    tag.innerText="€"+price;
    info.el.appendChild(tag);
  }
});
calendar.render();

function highlightDate(d){ 
  document.querySelector(`[data-date='${d.toISOString().split('T')[0]}']`).classList.add("selected-range");
}
function highlightRange(start,end){
  let cur=new Date(start);
  while(cur<=end){
    highlightDate(cur);
    cur.setDate(cur.getDate()+1);
  }
}
function clearSelection(){
  document.querySelectorAll(".selected-range").forEach(e=>e.classList.remove("selected-range"));
}

function showForm(){
  document.getElementById("bookingForm").style.display="block";
  updateSummary();
  generateGuestFields();
}

function updateSummary(){
  let nights=(checkout-checkin)/(1000*60*60*24);
  let total=nights*defaultPrice*parseInt(document.getElementById("rooms").value);
  document.getElementById("summaryBox").innerHTML=
  `<div><span class='highlight-date'>Check-in:</span> ${formatDate(checkin)}</div>
   <div><span class='highlight-date'>Check-out:</span> ${formatDate(checkout)}</div>
   <div>Notti | Nights: ${nights}</div>
   <div><b>Totale: €${total}</b></div>`;
}

function formatDate(d){ return d.toLocaleDateString("it-IT"); }

function changeRooms(v){
  let r=parseInt(rooms.value)+v;
  if(r<1) r=1;
  if(r>3) r=3;
  rooms.value=r;
  changeGuests(0);
  updateSummary();
}
function changeGuests(v){
  let max=rooms.value*2;
  let g=parseInt(guests.value)+v;
  if(g<1) g=1;
  if(g>max) g=max;
  guests.value=g;
  generateGuestFields();
}
function generateGuestFields(){
  let g=parseInt(guests.value);
  let html="";
  for(let i=1;i<=g;i++){
    html+=`<label>Nome e Cognome Ospite ${i} | Guest ${i} Name *</label>
           <input required>`;
  }
  guestNames.innerHTML=html;
}

function sendBooking(){
  let email=document.getElementById("email").value.trim();
  let confirm=document.getElementById("confirmEmail").value.trim();
  if(email!==confirm){ alert("Le email non coincidono"); return;}

  let templateParams={
    name: guestNames.querySelector("input").value,
    checkin: formatDate(checkin),
    checkout: formatDate(checkout),
    guests: guests.value,
    rooms: rooms.value,
    phone: document.getElementById("prefix").value+" "+phone.value,
    email: email
  };

  emailjs.send("service_IlFicobnb","template_pr1fttu",templateParams)
  .then(()=>{ alert("Richiesta inviata!"); location.reload(); },
        (e)=>{ alert("Errore invio email"); console.log(e); });
}
</script>
</body>
</html>
